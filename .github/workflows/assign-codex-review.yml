name: Assign Codex Review

on:
  pull_request:
    types: [ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Optional: pull request number to target (leave empty to process all open PRs)'
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write

jobs:
  assign-copilot:
    name: Assign Codex
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Add Codex verification comment if missing (BOT_ISSUE)
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.BOT_ISSUE }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const marker = "@codex - verify this PR";

            // Helper to ensure a PR has the marker comment
            const ensureComment = async (prNumber) => {
              const comments = await github.paginate(
                github.rest.issues.listComments,
                { owner, repo, issue_number: prNumber, per_page: 100 }
              );

              const alreadyExists = comments.some(c => (c.body || "").trim() === marker);

              if (alreadyExists) {
                core.info(`âœ… PR #${prNumber}: comment already exists â€“ skipping.`);
                return;
              }

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: marker
              });
              core.info(`ğŸ’¬ PR #${prNumber}: added Codex verification comment.`);
            };

            if (context.eventName === "workflow_dispatch") {
              // Manual run: use pr_number if provided; otherwise process ALL open PRs
              const inputPr = core.getInput("pr_number");

              if (inputPr) {
                core.info(`ğŸ”„ Manually triggered for PR #${inputPr}`);
                await ensureComment(Number(inputPr));
              } else {
                core.info("ğŸ”„ Manually triggered with no PR specified â€“ processing all open PRs.");
                const openPRs = await github.paginate(
                  github.rest.pulls.list,
                  { owner, repo, state: "open", per_page: 100 }
                );

                if (!openPRs.length) {
                  core.info("â„¹ï¸ No open pull requests found.");
                } else {
                  for (const pr of openPRs) {
                    await ensureComment(pr.number);
                  }
                }
              }
            } else {
              // Automatic run: Ready for review event
              const prNumber = context.payload.pull_request.number;
              core.info(`ğŸš€ Auto-triggered for PR #${prNumber} (ready_for_review).`);
              await ensureComment(prNumber);
            }