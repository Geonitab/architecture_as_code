name: Presentations (no-LLM)

on:
  workflow_call:

permissions:
  contents: read

env:
  OUTPUT_DIR: releases/presentation
  OUTPUT_FILE: architecture_as_code_presentation.pptx
  PANDOC_DEFAULTS: docs/pandoc.yaml

jobs:
  build-presentation:
    name: Generate presentations
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies (Pandoc)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Install Python dependencies (optional)
        run: |
          set -euo pipefail
          python -m pip install -U pip
          # Allow workflow to proceed even if requirements are empty/missing
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt || true
          fi

      - name: Gather slide sources
        id: gather
        shell: bash
        env:
          FIND_PATTERNS: |
            docs/*.md
            docs/part_*.md
            docs/*_*.md
        run: |
          set -euo pipefail
          shopt -s nullglob
          mkdir -p "${OUTPUT_DIR}"

          files=()
          # Collect markdown while skipping archived material and images
          while IFS= read -r pattern; do
            for f in $pattern; do
              case "$f" in
                docs/archive/*) continue ;;
                docs/images/*) continue ;;
                *) files+=("$f") ;;
              esac
            done
          done <<< "${FIND_PATTERNS}"

          if [ ${#files[@]} -eq 0 ]; then
            echo "::warning::No markdown sources found â€“ falling back to README.md"
            files=("README.md")
          fi

          printf '%s\n' "${files[@]}" > slide_sources.txt
          echo "count=${#files[@]}" >> "$GITHUB_OUTPUT"
          echo "First 10 sources:"
          head -n 10 slide_sources.txt || true

      - name: Build PPTX with Pandoc (no LLM)
        shell: bash
        env:
          PANDOC_ARGS: |
            --from gfm
            --to pptx
            --resource-path=.:docs:docs/images
            --embed-resources
        run: |
          set -euo pipefail
          mapfile -t src < slide_sources.txt

          # Use reference template if present
          if [ -f templates/presentation_reference.pptx ]; then
            REF="--reference-doc=templates/presentation_reference.pptx"
          else
            REF=""
          fi

          # Use shared Pandoc defaults if available
          if [ -f "${PANDOC_DEFAULTS}" ]; then
            DEFAULTS="--defaults=${PANDOC_DEFAULTS}"
          else
            DEFAULTS=""
          fi

          mkdir -p "${OUTPUT_DIR}"
          pandoc ${DEFAULTS} ${PANDOC_ARGS} ${REF} \
            --output "${OUTPUT_DIR}/${OUTPUT_FILE}" \
            "${src[@]}"

          ls -lh "${OUTPUT_DIR}/${OUTPUT_FILE}"

      - name: Upload presentation artefact
        uses: actions/upload-artifact@v4
        with:
          name: presentation
          path: ${{ env.OUTPUT_DIR }}/${{ env.OUTPUT_FILE }}
          retention-days: 30