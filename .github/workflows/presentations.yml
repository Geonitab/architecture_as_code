name: Presentations (no-LLM)

on:
  workflow_call:

permissions:
  contents: read

env:
  OUTPUT_DIR: releases/presentation
  OUTPUT_FILE: architecture_as_code_presentation.pptx
  PANDOC_DEFAULTS: docs/pandoc.yaml

jobs:
  build-presentation:
    name: Generate presentations
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies (Pandoc)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Install Python dependencies (optional)
        run: |
          set -euo pipefail
          python -m pip install -U pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt || true
          fi

      - name: Gather slide sources
        id: gather
        shell: bash
        env:
          FIND_PATTERNS: |
            docs/*.md
            docs/part_*.md
            docs/*_*.md
        run: |
          set -euo pipefail
          shopt -s nullglob
          mkdir -p "${OUTPUT_DIR}"

          files=()
          while IFS= read -r pattern; do
            for f in $pattern; do
              case "$f" in
                docs/archive/*) continue ;;
                docs/images/*) continue ;;
                *) files+=("$f") ;;
              esac
            done
          done <<< "${FIND_PATTERNS}"

          if [ ${#files[@]} -eq 0 ]; then
            echo "::warning::No markdown sources found – falling back to README.md"
            files=("README.md")
          fi

          printf '%s\n' "${files[@]}" > slide_sources.txt
          echo "count=${#files[@]}" >> "$GITHUB_OUTPUT"
          head -n 20 slide_sources.txt || true

      - name: Validate defaults/template and common assets
        id: validate
        shell: bash
        run: |
          set -euo pipefail

          echo "use_defaults=true" >> "$GITHUB_OUTPUT"
          echo "use_template=true" >> "$GITHUB_OUTPUT"

          if [ ! -f "${PANDOC_DEFAULTS}" ]; then
            echo "::notice::No ${PANDOC_DEFAULTS}; will build without --defaults"
            echo "use_defaults=false" >> "$GITHUB_OUTPUT"
          else
            REF_PATH="$(awk -F: '/^[[:space:]]*reference-doc[[:space:]]*:/ {sub(/^[^:]*:[[:space:]]*/,""); gsub(/[[:space:]]+/," "); print $0; exit}' "${PANDOC_DEFAULTS}" || true)"
            if [ -n "${REF_PATH}" ]; then
              REF_PATH="${REF_PATH%\"}"; REF_PATH="${REF_PATH#\"}"
              REF_PATH="${REF_PATH%\'}"; REF_PATH="${REF_PATH#\'}"
              if [ ! -f "${REF_PATH}" ]; then
                echo "::warning title=Missing reference-doc::${REF_PATH} referenced from ${PANDOC_DEFAULTS} does not exist."
                echo "use_template=false" >> "$GITHUB_OUTPUT"
              fi
            fi
          fi

          if [ -d docs/images ]; then
            find docs/images -maxdepth 1 -type f | head -n 50 || true
          fi

      - name: Build PPTX with Pandoc (no LLM) — primary attempt
        id: build1
        shell: bash
        env:
          PANDOC_ARGS: |
            --from gfm
            --to pptx
            --resource-path=.:docs:docs/images
            --embed-resources
        run: |
          set +e
          mapfile -t src < slide_sources.txt

          DEFAULTS_ARG=""
          REF_ARG=""

          # Only add --defaults if the file exists and was validated
          if [ "${{ steps.validate.outputs.use_defaults }}" = "true" ]; then
            DEFAULTS_ARG="--defaults=${PANDOC_DEFAULTS}"
          fi

          # If template flagged unusable in defaults, try a standalone template file
          if [ "${{ steps.validate.outputs.use_template }}" != "true" ]; then
            if [ -f templates/presentation_reference.pptx ]; then
              REF_ARG="--reference-doc=templates/presentation_reference.pptx"
            fi
          fi

          mkdir -p "${OUTPUT_DIR}"
          pandoc ${DEFAULTS_ARG} ${PANDOC_ARGS} ${REF_ARG} \
            --output "${OUTPUT_DIR}/${OUTPUT_FILE}" \
            "${src[@]}"
          rc=$?

          # Expose exit code + whether a fallback is needed
          echo "rc=${rc}" >> "$GITHUB_OUTPUT"
          if [ "$rc" -eq 97 ]; then
            echo "needs_fallback=true" >> "$GITHUB_OUTPUT"
          else
            echo "needs_fallback=false" >> "$GITHUB_OUTPUT"
          fi

          # Do not fail the job here; let the next step decide.
          exit 0

      - name: Build PPTX with Pandoc — fallback (no defaults/template)
        if: ${{ steps.build1.outputs.needs_fallback == 'true' }}
        shell: bash
        env:
          PANDOC_ARGS: |
            --from gfm
            --to pptx
            --resource-path=.:docs:docs/images
            --embed-resources
        run: |
          set -euo pipefail
          mapfile -t src < slide_sources.txt
          mkdir -p "${OUTPUT_DIR}"
          echo "::notice::Retrying without --defaults or --reference-doc (Pandoc 97 recovery)."
          pandoc ${PANDOC_ARGS} \
            --output "${OUTPUT_DIR}/${OUTPUT_FILE}" \
            "${src[@]}"
          ls -lh "${OUTPUT_DIR}/${OUTPUT_FILE}"

      - name: Fail if pandoc returned a non-zero code other than 97
        if: ${{ steps.build1.outputs.rc != '0' && steps.build1.outputs.rc != '97' }}
        run: |
          echo "::error title=Pandoc failed::Exit code ${{ steps.build1.outputs.rc }} on primary attempt."
          exit 1

      - name: Upload presentation artefact
        uses: actions/upload-artifact@v4
        with:
          name: presentation
          path: ${{ env.OUTPUT_DIR }}/${{ env.OUTPUT_FILE }}
          retention-days: 30