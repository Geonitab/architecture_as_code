name: "Assistant - New Issue"

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  propose-changes:
    name: Propose patch for issue
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Gather context
        id: ctx
        run: |
          set -eu
          echo "Issue title: ${{ github.event.issue.title }}"
          printf "Issue body length: %s\n" "$(printf %s "${{ github.event.issue.body }}" | wc -c)"

      - name: Validate secrets
        id: validate
        run: |
          set -eu
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "Error: Missing required secret OPENAI_API_KEY."
            echo "Add it in Settings -> Secrets and variables -> Actions."
            exit 1
          fi
          echo "Secrets validation passed."

      - name: Prepare context
        id: context
        run: |
          set -eu
          git ls-files > files.txt
          {
            printf '<<FILE_LIST>>\n'
            sed -e 's/^/ - /' files.txt
          } > prompt_context.txt
          echo "Prepared repository file list for model context."

      - name: Call OpenAI to propose a patch
        id: openai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ vars.OPENAI_BASE_URL || 'https://api.openai.com' }}
          MODEL: ${{ vars.OPENAI_MODEL || 'gpt-4o-mini' }}
          PROMPT: |
            You are a meticulous software maintainer.
            Return a minimal, safe patch as a unified diff that applies cleanly to the current HEAD.
            Output only the diff â€” no code fences, no explanations, no backticks.
            The first two lines must be file headers like:
            --- path/to/file.ext
            +++ path/to/file.ext

            Context:
            - Issue title: "${{ github.event.issue.title }}"
            - Issue body (may be empty): |
              ${{ github.event.issue.body }}

            Repository snapshot (filenames only):
            <<FILE_LIST>>
        run: |
          set -eu
          PROMPT_FULL="$(printf '%s\n\n%s' "$PROMPT" "$(cat prompt_context.txt)")"

          body=$(jq -n --arg model "$MODEL" --arg prompt "$PROMPT_FULL" '{
            model: $model,
            messages: [{ "role": "user", "content": $prompt }]
          }')

          echo "Sending request to OpenAI..."
          response=$(curl -sS -X POST "$OPENAI_BASE_URL/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$body")

          if echo "$response" | jq -e '.error' >/dev/null; then
            echo "OpenAI API returned an error:"
            echo "$response" | jq '.error'
            exit 1
          fi

          jq -r '.choices[0].message.content' <<<"$response" > raw.patch.txt

          echo "Raw model output (first 40 lines):"
          head -n 40 raw.patch.txt || true

      - name: Sanitise generated patch
        id: clean
        run: |
          set -eu
          # 1) Remove surrounding code fences if present
          awk 'NR==1 && /^```/ {next} /^```$/ {next} {print}' raw.patch.txt > step1.txt

          # 2) Drop any leading prose until the first unified diff header line
          awk '/^--- /{s=1} s{print}' step1.txt > step2.txt || true

          # 3) Normalise CRLF to LF
          tr -d '\r' < step2.txt > patch.diff || true

          echo "Sanitised patch preview (first 60 lines):"
          head -n 60 patch.diff || true

          if ! grep -qE '^(--- |\+\+\+ )' patch.diff; then
            echo "No unified diff headers detected after sanitisation."
            echo "Model output was (first 80 lines):"
            sed -n '1,80p' raw.patch.txt || true
            exit 1
          fi

      - name: Apply proposed patch
        run: |
          set -eu
          echo "Validating patch applies cleanly..."
          git apply --check patch.diff
          git apply patch.diff
          echo "Patch applied."

      - name: Commit and push changes
        id: push
        run: |
          set -eu
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          branch="issue-${{ github.event.issue.number }}"
          git checkout -b "$branch"
          git add -A
          git commit -m "Proposed fix for issue #${{ github.event.issue.number }}"
          git push origin "$branch"
          echo "branch=$branch" >> "$GITHUB_OUTPUT"

      - name: Create pull request
        if: ${{ steps.push.outputs.branch != '' }}
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.push.outputs.branch }}
          title: "Proposed fix for issue #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"
          body: |
            This PR was automatically generated by the assistant workflow
            in response to issue #${{ github.event.issue.number }}.
            Please review the proposed patch below.
          labels: |
            automated
            assistant

      - name: Comment on issue with PR link
        if: ${{ steps.cpr.outputs.pull-request-url != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prUrl = "${{ steps.cpr.outputs.pull-request-url }}";
            const issueNumber = ${{ github.event.issue.number }};
            const body = [
              "Hello! A pull request has been automatically created for this issue:",
              prUrl,
              "",
              "Please review it when you have a moment."
            ].join("\n");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body
            });