name: Generate Presentations

# This workflow automatically generates PowerPoint presentation materials from book chapters
# when relevant files are changed. It creates presentation outlines, PowerPoint generation
# scripts, and necessary dependencies for creating professional presentations.

on:
  push:
    branches: [main]
    paths:
      - 'docs/**/*.md'              # Trigger when book chapters are updated
      - 'generate_presentation.py'  # Trigger when the generation script is modified
      - '.github/workflows/generate-presentations.yml'  # Trigger on workflow changes
  pull_request:
    branches: [main]
    paths:
      - 'docs/**/*.md'
      - 'generate_presentation.py'
      - '.github/workflows/generate-presentations.yml'
  workflow_dispatch: {}  # Allow manual triggering

env:
  ARTIFACT_RETENTION_DAYS: 30

jobs:
  generate-presentations:
    name: 📊 Generate Presentation Materials
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🐍 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: 📦 Install Python dependencies
        run: |
          echo "=== Installing Python dependencies ==="
          python3 -m pip install --upgrade pip
          
          # Install presentation dependencies
          echo "📊 Installing PowerPoint and YAML dependencies..."
          if pip install python-pptx>=0.6.21 PyYAML>=6.0; then
            echo "✅ python-pptx and PyYAML installed successfully"
          else
            echo "❌ ERROR: Failed to install presentation dependencies"
            exit 1
          fi

          # Verify python-pptx is available
          echo "🔍 Verifying python-pptx installation..."
          if python3 -c "import pptx; print(f'python-pptx version: {pptx.__version__}')"; then
            echo "✅ python-pptx is available and working"
          else
            echo "❌ ERROR: python-pptx cannot be imported"
            exit 1
          fi

          # Verify PyYAML is available
          echo "🔍 Verifying PyYAML installation..."
          if python3 -c "import yaml; print(f'PyYAML version: {yaml.__version__}')"; then
            echo "✅ PyYAML is available and working"
          else
            echo "❌ ERROR: PyYAML cannot be imported"
            exit 1
          fi
          
          echo "✅ All Python dependencies installed"

      - name: 🔍 Pre-validation checks
        run: |
          echo "=== Pre-validation checks ==="
          
          # Check if docs directory exists
          if [ ! -d "docs" ]; then
            echo "⚠️  WARNING: docs/ directory not found"
            echo "   Creating minimal docs structure for testing"
            mkdir -p docs
            echo "# Test Chapter" > docs/test_chapter.md
            echo "This is a test chapter for presentation generation." >> docs/test_chapter.md
          fi
          
          # Check if docs contains markdown files
          markdown_count=$(find docs -name "*.md" -type f | wc -l)
          if [ "$markdown_count" -eq 0 ]; then
            echo "⚠️  WARNING: No markdown files found in docs/ directory"
            echo "   Creating minimal test content for presentation generation"
            echo "# Test Chapter" > docs/test_chapter.md
            echo "This is a test chapter for presentation generation." >> docs/test_chapter.md
            markdown_count=1
          fi
          
          echo "✅ Found $markdown_count markdown files in docs/ directory"
          
          # Ensure presentations directory exists
          mkdir -p presentations
          echo "✅ Presentations directory ready"
          
          # Check if generate_presentation.py exists
          if [ ! -f "generate_presentation.py" ]; then
            echo "❌ ERROR: generate_presentation.py script not found"
            echo "   This script is required for presentation generation"
            echo "   Current directory contents:"
            ls -la
            exit 1
          fi
          
          echo "✅ generate_presentation.py script found"
          echo "✅ Pre-validation checks completed successfully"

      - name: 📊 Generate presentation materials and PowerPoint file
        run: |
          echo "=== Generating presentation materials and PowerPoint file ==="
          echo "📖 Reading from docs/ directory (read-only access)"
          echo "📁 Output will be generated in presentations/ directory"
          echo "🎯 Enhanced features:"
          echo "   - Word limit: 20 words maximum per slide key point"
          echo "   - Diagram integration: Automatic inclusion of chapter diagrams"
          echo "   - Swedish theme: Professional blue color scheme"
          
          # Run the presentation generation script with --create-pptx flag
          if python3 generate_presentation.py --create-pptx; then
            echo "✅ Presentation generation and PowerPoint creation completed successfully"
          else
            echo "❌ ERROR: Presentation generation failed"
            echo "   Check the script output above for specific error details"
            exit 1
          fi

      - name: 📋 Validate generated files
        run: |
          echo "=== Validating generated presentation files ==="
          
          # Initialize validation status
          validation_failed=false
          
          # Check if the expected files were created
          echo "🔍 Checking for presentation_outline.md..."
          if [ -f "presentations/presentation_outline.md" ]; then
            file_size=$(ls -lh presentations/presentation_outline.md | awk '{print $5}')
            line_count=$(wc -l < presentations/presentation_outline.md)
            echo "✅ Presentation outline generated successfully"
            echo "   📄 File size: $file_size"
            echo "   📄 Line count: $line_count"
          else
            echo "❌ VALIDATION ERROR: presentation_outline.md is missing"
            echo "   Expected location: presentations/presentation_outline.md"
            validation_failed=true
          fi
          
          echo "🔍 Checking for generate_pptx.py..."
          if [ -f "presentations/generate_pptx.py" ]; then
            file_size=$(ls -lh presentations/generate_pptx.py | awk '{print $5}')
            line_count=$(wc -l < presentations/generate_pptx.py)
            echo "✅ PowerPoint generation script created successfully"
            echo "   📄 File size: $file_size"
            echo "   📄 Line count: $line_count"
          else
            echo "❌ VALIDATION ERROR: generate_pptx.py is missing"
            echo "   Expected location: presentations/generate_pptx.py"
            validation_failed=true
          fi
          
          echo "🔍 Checking for requirements.txt..."
          if [ -f "presentations/requirements.txt" ]; then
            file_size=$(ls -lh presentations/requirements.txt | awk '{print $5}')
            echo "✅ Requirements file created successfully"
            echo "   📄 File size: $file_size"
            echo "   📄 Dependencies: $(cat presentations/requirements.txt | tr '\n' ' ')"
          else
            echo "❌ VALIDATION ERROR: requirements.txt is missing"
            echo "   Expected location: presentations/requirements.txt"
            validation_failed=true
          fi
          
          echo "🔍 Checking for PowerPoint presentation file..."
          if [ -f "presentations/arkitektur_som_kod_presentation.pptx" ]; then
            file_size=$(ls -lh presentations/arkitektur_som_kod_presentation.pptx | awk '{print $5}')
            echo "✅ PowerPoint presentation file created successfully"
            echo "   📄 File size: $file_size"
            echo "   📄 File type: $(file presentations/arkitektur_som_kod_presentation.pptx)"
          else
            echo "❌ VALIDATION ERROR: arkitektur_som_kod_presentation.pptx is missing"
            echo "   Expected location: presentations/arkitektur_som_kod_presentation.pptx"
            validation_failed=true
          fi
          
          # Final validation result
          if [ "$validation_failed" = true ]; then
            echo ""
            echo "❌ FILE VALIDATION FAILED"
            echo "   One or more required files were not generated"
            echo "   Please check the presentation generation step for errors"
            exit 1
          fi
          
          echo ""
          echo "✅ All expected presentation files validated successfully"

      - name: 📈 Presentation generation summary
        run: |
          echo "=== Presentation Generation Summary ==="
          echo "📚 Source chapters: $(ls docs/*.md | wc -l)"
          
          if [ -f "presentations/presentation_outline.md" ]; then
            outline_sections=$(grep -c "^##" presentations/presentation_outline.md || echo "0")
            echo "📋 Presentation sections: $outline_sections"
          fi
          
          if [ -f "presentations/generate_pptx.py" ]; then
            script_lines=$(wc -l < presentations/generate_pptx.py)
            echo "📝 PowerPoint script lines: $script_lines"
          fi
          
          if [ -f "presentations/arkitektur_som_kod_presentation.pptx" ]; then
            pptx_size=$(ls -lh presentations/arkitektur_som_kod_presentation.pptx | awk '{print $5}')
            echo "📊 PowerPoint file size: $pptx_size"
          fi
          
          echo "📁 Generated files:"
          ls -la presentations/
          echo "⏰ Generation completed at: $(date)"

      - name: 📤 Upload presentation materials
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: presentation-materials
          path: |
            presentations/presentation_outline.md
            presentations/generate_pptx.py
            presentations/requirements.txt
            presentations/arkitektur_som_kod_presentation.pptx
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: 📝 Create presentation summary (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let summary = `## 📊 Presentation Materials Generated\n\n`;
            
            // Check if files exist and get basic info
            try {
              if (fs.existsSync('presentations/presentation_outline.md')) {
                const outline = fs.readFileSync('presentations/presentation_outline.md', 'utf8');
                const sections = (outline.match(/^##/gm) || []).length;
                summary += `- ✅ **Presentation Outline**: ${sections} sections generated\n`;
              }
              
              if (fs.existsSync('presentations/generate_pptx.py')) {
                const script = fs.readFileSync('presentations/generate_pptx.py', 'utf8');
                const lines = script.split('\n').length;
                summary += `- ✅ **PowerPoint Script**: ${lines} lines of Python code\n`;
              }
              
              if (fs.existsSync('presentations/requirements.txt')) {
                const requirements = fs.readFileSync('presentations/requirements.txt', 'utf8');
                summary += `- ✅ **Dependencies**: ${requirements.trim()}\n`;
              }
            } catch (error) {
              summary += `- ⚠️ Error reading generated files: ${error.message}\n`;
            }
            
            try {
              if (fs.existsSync('presentations/arkitektur_som_kod_presentation.pptx')) {
                const stats = fs.statSync('presentations/arkitektur_som_kod_presentation.pptx');
                const fileSize = (stats.size / 1024).toFixed(1); // Size in KB
                summary += `- ✅ **PowerPoint File**: ${fileSize} KB presentation ready for download\n`;
              }
            } catch (error) {
              summary += `- ⚠️ Error reading PowerPoint file: ${error.message}\n`;
            }
            
            summary += `\n### 🚀 Ready to Use\n`;
            summary += `The PowerPoint presentation has been generated and is ready for immediate use!\n\n`;
            summary += `📋 **All generated files are available in the workflow artifacts:**\n`;
            summary += `- 📋 Presentation outline (Markdown)\n`;
            summary += `- 📝 Generation script (Python)\n`;
            summary += `- 📊 **PowerPoint presentation (.pptx)** - Ready to download and present\n`;
            summary += `- 📦 Requirements file\n\n`;
            summary += `*Automated by Presentation Generation Workflow*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: 🔍 Validate docs protection
        run: |
          echo "=== Validating docs directory protection ==="
          
          # Check if the validation script exists
          if [ -f "scripts/validate_docs_protection.py" ]; then
            if python3 scripts/validate_docs_protection.py; then
              echo "✅ Docs protection validation completed successfully"
            else
              echo "⚠️  Docs protection validation completed with warnings"
              # Don't fail the workflow for docs protection warnings
            fi
          else
            echo "⚠️  Warning: docs protection validation script not found"
            echo "   Expected location: scripts/validate_docs_protection.py"
            echo "   Skipping docs protection validation"
          fi
          
          # Additional basic check - ensure no docs files were modified
          echo "🔍 Basic docs protection check..."
          if [ -d "docs" ]; then
            echo "✅ Docs directory exists and appears intact"
          else
            echo "⚠️  Warning: docs directory not found - this should not happen"
          fi