name: Site (no-LLM)

on:
  workflow_call:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

env:
  MKDOCS_CONFIG: mkdocs.yml
  BUILD_DIR: releases/website

jobs:
  site:
    name: Build site
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies (always include MkDocs)
        env:
          REQUIREMENTS_FILE: requirements.txt
        run: |
          set -euo pipefail
          python -m pip install -U pip
          # Always ensure mkdocs CLI is present
          python -m pip install "mkdocs>=1.5" "mkdocs-material>=9.5"
          # If you have extra plugins/deps, install them too
          if [ -f "${REQUIREMENTS_FILE}" ]; then
            python -m pip install -r "${REQUIREMENTS_FILE}"
          fi
          # Show whatâ€™s installed (helps debugging PATH/versions)
          python -m pip show mkdocs || true
          python -m pip show mkdocs-material || true

      - name: Build MkDocs site (no LLM)
        env:
          MKDOCS_ARGS: |
            --config-file "${MKDOCS_CONFIG}"
            --site-dir "${BUILD_DIR}"
        run: |
          set -euo pipefail
          if [ ! -f "${MKDOCS_CONFIG}" ]; then
            echo "::error title=Missing mkdocs.yml::Expected ${MKDOCS_CONFIG} at repo root"
            exit 1
          fi
          mkdocs --version
          mkdocs build ${MKDOCS_ARGS}
          test -d "${BUILD_DIR}" && ls -la "${BUILD_DIR}" | head -n 50

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.BUILD_DIR }}

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4