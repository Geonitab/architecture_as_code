name: Site (no-LLM)

on:
  workflow_call:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

env:
  MKDOCS_CONFIG: mkdocs.yml
  BUILD_DIR: releases/website

jobs:
  site:
    name: Build site
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install MkDocs core
        run: |
          set -euo pipefail
          python -m pip install -U pip
          # Ensure mkdocs CLI is present regardless of repo requirements
          python -m pip install "mkdocs>=1.5" "mkdocs-material>=9.5"
          mkdocs --version || true

      - name: Detect and install MkDocs plugins from mkdocs.yml
        if: ${{ hashFiles(env.MKDOCS_CONFIG) != '' }}
        run: |
          set -euo pipefail
          echo "Reading plugins from ${MKDOCS_CONFIG}…"
          # Extract plugin identifiers from mkdocs.yml; tolerate both list and keyed forms.
          plugins=$(awk '
            BEGIN{inplugins=0}
            /^[[:space:]]*plugins:[[:space:]]*$/ {inplugins=1; next}
            inplugins==1 && /^[[:space:]]*[^[:space:]-]/ {inplugins=0}
            inplugins==1 {
              # lines like "- search" or "- mermaid2" or "- git-revision-date-localized: {}"
              gsub(/^- /,""); gsub(/:.*/,"");
              if (length($0)>0) print $0
            }
          ' "${MKDOCS_CONFIG}" | sort -u)

          if [ -z "${plugins}" ]; then
            echo "No plugins declared in ${MKDOCS_CONFIG}."
            exit 0
          fi

          echo "Plugins detected:"
          printf ' - %s\n' ${plugins}

          # Map common plugin names to PyPI packages
          to_install=()
          for p in ${plugins}; do
            case "$p" in
              search) ;; # built-in
              material) ;; # theme already installed
              awesome-pages) to_install+=("mkdocs-awesome-pages-plugin");;
              git-revision-date) to_install+=("mkdocs-git-revision-date-plugin");;
              git-revision-date-localized) to_install+=("mkdocs-git-revision-date-localized-plugin");;
              macros) to_install+=("mkdocs-macros-plugin");;
              mermaid2|mermaid) to_install+=("mkdocs-mermaid2-plugin");;
              redirects) to_install+=("mkdocs-redirects");;
              minify) to_install+=("mkdocs-minify-plugin");;
              i18n|static-i18n) to_install+=("mkdocs-static-i18n");;
              rss) to_install+=("mkdocs-rss-plugin");;
              encryptcontent) to_install+=("mkdocs-encryptcontent-plugin");;
              # Fallback: try "mkdocs-<name>-plugin"
              *)
                guess="mkdocs-${p}-plugin"
                to_install+=("${guess}")
                ;;
            esac
          done

          # Install, but don’t fail the whole job if a guessed package doesn’t exist
          if [ ${#to_install[@]} -gt 0 ]; then
            echo "Installing plugin packages:"
            printf ' - %s\n' "${to_install[@]}"
            python -m pip install "${to_install[@]}" || true
          fi

      - name: Install extra Python requirements (optional)
        env:
          REQUIREMENTS_FILE: requirements.txt
        run: |
          set -euo pipefail
          if [ -f "${REQUIREMENTS_FILE}" ]; then
            echo "Installing ${REQUIREMENTS_FILE}…"
            python -m pip install -r "${REQUIREMENTS_FILE}"
          else
            echo "No ${REQUIREMENTS_FILE}; skipping."
          fi

      - name: Show MkDocs environment
        run: |
          set -euo pipefail
          echo "mkdocs version:"
          mkdocs --version || true
          echo "Installed mkdocs* packages:"
          python - << 'PY'
import pkgutil, sys
mods = sorted(m for m in pkgutil.iter_modules() if m.name.startswith('mkdocs'))
for m in mods:
    print(m.name)
PY

      - name: Build MkDocs site (strict)
        env:
          MKDOCS_ARGS: |
            --config-file "${MKDOCS_CONFIG}"
            --site-dir "${BUILD_DIR}"
            --strict
        run: |
          set -euo pipefail
          if [ ! -f "${MKDOCS_CONFIG}" ]; then
            echo "::error title=Missing mkdocs.yml::Expected ${MKDOCS_CONFIG} at repo root"
            exit 1
          fi
          echo "Using config ${MKDOCS_CONFIG}:"
          sed -n '1,200p' "${MKDOCS_CONFIG}" || true
          mkdocs build ${MKDOCS_ARGS}
          test -d "${BUILD_DIR}" && ls -la "${BUILD_DIR}" | head -n 50

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.BUILD_DIR }}

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4