name: Build & (Optional) Deploy MkDocs Site

on:
  workflow_call:
    inputs:
      mkdocs_config:
        description: Path to mkdocs.yml
        required: false
        type: string
        default: mkdocs.yml
      python_version:
        description: Python version
        required: false
        type: string
        default: "3.12"
      deploy_to_pages:
        description: Deploy to GitHub Pages after build
        required: false
        type: boolean
        default: false
    secrets: {}
  workflow_dispatch: {}
  push:
    branches: [ main ]
    paths:
      - "mkdocs.yml"
      - "docs/**"
      - ".github/workflows/site.yml"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "site-${{ github.ref }}"
  cancel-in-progress: true

env:
  SITE_DIR: site

jobs:
  site:
    name: Site / site
    runs-on: ubuntu-latest
    timeout-minutes: 25
    environment: ${{ inputs.deploy_to_pages && 'github-pages' || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show tree (quick sanity)
        run: |
          set -euxo pipefail
          pwd
          ls -la
          [ -f "${{ inputs.mkdocs_config }}" ] && echo "Found ${{ inputs.mkdocs_config }}" || (echo "::error ::No mkdocs.yml at ${{ inputs.mkdocs_config }}"; exit 2)

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: pip

      - name: Bootstrap pip & wheels
        run: |
          set -euxo pipefail
          python -V
          python -m pip install --upgrade pip setuptools wheel

      - name: Install dependencies (requirements + ensure MkDocs plugins)
        run: |
          set -euxo pipefail
          # 1) If a requirements.txt exists, install it first
          if [[ -f requirements.txt ]]; then
            python -m pip install -r requirements.txt
          fi

          # 2) Ensure core MkDocs + plugins are present regardless of requirements.txt contents
          #    (idempotent; will upgrade/skip as needed)
          python -m pip install --upgrade \
            mkdocs \
            mkdocs-material \
            mkdocs-material-extensions \
            mkdocs-mermaid2-plugin \
            mkdocs-awesome-pages-plugin \
            mkdocs-redirects

          # 3) Verify installation
          python - <<'PY'
          import sys, importlib
          pkgs = ["mkdocs",
                  "mkdocs_material",
                  "mkdocs_mermaid2_plugin",
                  "mkdocs_awesome_pages_plugin",
                  "mkdocs_redirects"]
          for p in pkgs:
            try:
              m = importlib.import_module(p)
              print("OK:", p, getattr(m, "__version__", "(no __version__)"))
            except Exception as e:
              print("MISSING:", p, e)
              sys.exit(1)
          PY

      - name: Print MkDocs config & docs index
        run: |
          set -euxo pipefail
          echo "===== mkdocs.yml ====="
          cat "${{ inputs.mkdocs_config }}"
          echo "===== docs/ ====="
          ls -la docs || true
          echo "===== images/ ====="
          ls -la docs/images || true

      - name: Configure GitHub Pages (only if deploying)
        if: ${{ inputs.deploy_to_pages }}
        uses: actions/configure-pages@v5

      - name: Build site (strict & verbose)
        run: |
          set -euxo pipefail
          python -m mkdocs build \
            --strict \
            --clean \
            --config-file "${{ inputs.mkdocs_config }}" \
            --site-dir "${SITE_DIR}"

      - name: Upload Pages artifact (only if deploying)
        if: ${{ inputs.deploy_to_pages }}
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.SITE_DIR }}

      - name: Deploy to GitHub Pages (only if deploying)
        if: ${{ inputs.deploy_to_pages }}
        id: deploy
        uses: actions/deploy-pages@v4

      - name: Summarise result
        if: always()
        run: |
          set -euxo pipefail
          echo "Built output:"
          du -sh "${SITE_DIR}" || true
          ls -la "${SITE_DIR}" || true
          if [ -n "${{ steps.deploy.outputs.page_url || '' }}" ]; then
            echo "Deployed to: ${{ steps.deploy.outputs.page_url }}"
          fi