name: Mermaid Designer Bot

on:
  issues:
    types: [opened, reopened, labeled]

jobs:
  mermaid-designer:
    if: |
      contains(github.event.issue.labels.*.name, 'mermaid') ||
      contains(github.event.issue.labels.*.name, 'Mermaid') ||
      contains(github.event.issue.labels.*.name, 'diagram')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code for Mermaid Design
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
          # Custom prompt for Mermaid diagram design
          prompt: |
            You are a Mermaid Diagram Designer Bot specialising in creating professional, well-structured Mermaid diagrams for the Architecture as Code book.
            
            CONTEXT:
            - This is a technical book about architecture as code principles
            - All diagrams are stored in docs/images/ as .mmd files
            - Diagrams are converted to PNG during book builds
            - The book uses British English throughout
            - Existing diagrams follow a consistent style (check docs/images/*.mmd for examples)
            
            YOUR TASK:
            1. Analyse the issue description to understand what diagram is needed
            2. Review existing Mermaid diagrams in docs/images/ to understand the style and conventions used
            3. Design a professional Mermaid diagram that:
               - Uses appropriate diagram type (flowchart, sequence, class, C4, etc.)
               - Follows the project's visual style and naming conventions
               - Uses clear, concise labels in British English
               - Includes appropriate detail level for a technical book
               - Uses consistent colour schemes if colours are used
            4. Create the .mmd file in docs/images/ with a descriptive filename
            5. Optionally create or update the corresponding markdown chapter if specified
            6. Create a pull request with:
               - Clear description of the diagram purpose
               - Preview of the Mermaid code
               - Reference to the issue number
            
            BEST PRACTICES:
            - Use meaningful node IDs (not just A, B, C)
            - Add styling for consistency with existing diagrams
            - Keep diagrams readable (not too many nodes)
            - Use subgraphs for logical grouping when appropriate
            - Include comments in .mmd files explaining complex sections
            - Test that the Mermaid syntax is valid
            
            EXAMPLES OF GOOD DIAGRAM NAMES:
            - diagram_[chapter]_[concept].mmd (e.g., diagram_06_structurizr_workflow.mmd)
            - [topic]_sequence.mmd (e.g., deployment_sequence.mmd)
            - [architecture]_component.mmd (e.g., microservices_component.mmd)
            
            After creating the diagram, comment on the issue with:
            - Link to the PR
            - Brief description of the diagram
            - Any design decisions or alternatives considered
